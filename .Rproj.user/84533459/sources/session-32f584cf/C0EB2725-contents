---
title: "draft"
format: html
editor: visual
---

New dataset downloaded from https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html County based

# Import data, clean data

```{r}
remove(list=ls())
setwd("C:\\Users\\edoar\\Desktop\\BIS620 Data Science Software Systems\\project") 

library(readr)
library(tibble)
library(dplyr)
data <- read.csv("SVI_2020_US_county.csv", sep = ',', header = T, row.names = NULL)
data <- tibble(data)

mnnn_to_na <- function(x) {
  x[x == -999] <- NA
  return(x)
}

data <- data |> 
  mutate_if(is.double, mnnn_to_na)
```

Mutate the -999 in NA, since the dataset is meant to be analyzed on SAS.

Now prepare the data set for our analysis, adding a column with the percentage of with people in each county and a flag column which indicates the most represented race in each county as follows - W: white - AF: African-American - H: Hipanic - A: Asian - N: Native Hawaiian or other Pacific Islands - O: Other races

```{r}

# Adding percentage of white people

# data |> 
#   mutate(EP_WHITE = EP_AFAM + EP_HISP + EP_ASIAN + EP_NHPI + EP_OTHERRACE) |>
#   select(EP_AFAM, EP_HISP, EP_ASIAN, EP_NHPI, EP_OTHERRACE, EP_WHITE) |>
#   View()

data <- data |> 
  mutate(EP_WHITE = 100 - (EP_AFAM + EP_HISP + EP_ASIAN + EP_NHPI + EP_OTHERRACE))

flag_creator <- function(row){
  # browser()
   race <- row |>
     which.max()
   
   if(race == 1)
     return("AF")
   else if(race == 2)
     return("H")
   else if(race == 3)
     return("A")
   else if(race == 4)
     return("N")
   else if(race == 5)
     return("O")
   else
     return("W")
}
  
flag <- data |>
  select(EP_AFAM, EP_HISP, EP_ASIAN, EP_NHPI, EP_OTHERRACE, EP_WHITE) |>
  apply(1, flag_creator)

# data |>
#   mutate(F_RACE = flag) |>
#   select(EP_AFAM, EP_HISP, EP_ASIAN, EP_NHPI, EP_OTHERRACE, EP_WHITE, F_RACE) |>
#   View()

data <- data |>
  mutate(F_RACE = flag)


```

```{r}
data |>
  select(F_RACE) |>
  table()
```

We observe that the majority of counties presents a prevalence of white people. However, a non negligible number of counties presents African-American of Hispanic communities that are larger than the white people ones. It is indeed interesting to analyse if there is any evidence of difference in general wealth between those counties. Note that we disregard the counties with Asian and Native prevalence, due to the poor numerosity. Another approach can be to create a third category gathering the two, but still the aggregate numerosity is not enough to justify this approach.

Our target variable is the housing cost burden, that is, the percentage of households that spend 30% or more of annual income on house cost.

```{r}
# disregard Asian and Native
data <- data |>
  filter(F_RACE != "A" & F_RACE != "N")

data |>
  select(F_RACE) |>
  table()


```

```{r}
library(gtsummary)
data |>
  select(EP_HBURD, F_RACE) |>
  tbl_summary(by = F_RACE)
```

# Visualization

```{r}
boxplot(EP_HBURD~F_RACE, data, col=c('cornflowerblue','darkgoldenrod1', 'peachpuff3'), main = 'Housing cost burden percentage', names = c('African-American', 'Hispanic', 'White'), xlab = '', ylab = 'Percentage')


```

Some differences can be observed among groups, is there statistical evidence?

# Test

```{r}
# Permutational ANOVA
# H0: tau1 = tau2 = tau3 = tau4 = tau5 = tau6 = 0
# no group specific effect

# H1: (H0)^c
# there are at least two different populations

# g <- data |> 
#   select(F_RACE) |>
#   unique() |>
#   count()

n <- data |>
  nrow()

response <- data |>
  pull(EP_HBURD)
grouping <- data |>
  pull(F_RACE)



fit <- aov(EP_HBURD ~ F_RACE, data = data)
T0 <- summary(fit)[[1]][1,4]

B <- 1000 # Number of permutations
T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  response_perm <- response[permutation]
  fit_perm <- aov(response_perm ~ grouping)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}

layout(1)
hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val
```

Statistical evidence of difference between groups

# Can the percentage be predictive?

```{r}
train <- data |> 
  sample_frac(0.70)
test  <- data |>
  anti_join(train, by = 'COUNTY')
```

```{r}

# linear regression
regression <- lm(EP_HBURD ~ 
                   EP_WHITE +
                   EP_AFAM + 
                   EP_HISP + 
                   EP_ASIAN +
                   EP_NHPI, data = train)

summary(regression)
shapiro.test(regression$residuals) # not normal
# plot(regression)

# library(ModelMetrics)
# test_fit <- predict(regression, test)
# mse(test_fit, test$EP_HBURD)

# not interpretable pvalues, not normality of residuals


# Overall model 
# H0: beta1 = beta2 = beta3 = beta4 = beta5 = 0
# test statistic
T0_glob <- summary(regression)$f[1]
T0_glob

response <- train |>
  pull(EP_HBURD)

n <- train |>
  nrow()

B <- 1000
T_H0glob <- numeric(B)

for(perm in 1:B){
  
  train_copy <- train
  
  permutation <- sample(n)
  
  response_perm <- response[permutation]
  
  train_copy <- train |>
    mutate(response_perm = response_perm)
  
  T_H0glob[perm] <- summary(
    lm(response_perm ~ 
         EP_WHITE +
         EP_AFAM + 
         EP_HISP + 
         EP_ASIAN +
         EP_NHPI, data = train_copy))$f[1]
  
}

sum(T_H0glob>=T0_glob)/B








```

```{r}
library(mgvc)

model_gam <- mgcv::gam(EP_HBURD ~ 
                         s(EP_WHITE,bs='cr') +
                         s(EP_AFAM,bs='cr') +
                         s(EP_HISP,bs='cr') +
                         s(EP_ASIAN,bs='cr') +
                         s(EP_NHPI,bs='cr'), 
                       data = data) 

summary(model_gam)

res <- model_gam$residuals
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)

model_gam <- mgcv::gam(EP_HBURD ~ 
                         s(EP_WHITE,bs='cr') +
                         s(EP_AFAM,bs='cr') +
                         s(EP_HISP,bs='cr') +
                         s(EP_ASIAN,bs='cr') +
                         s(EP_NHPI,bs='cr'),
                       data = data) 
summary(model_gam)

```
